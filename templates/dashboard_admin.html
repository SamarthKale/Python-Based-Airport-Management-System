<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background-color: #0d6efd; /* Bootstrap primary */
            padding-top: 1rem;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
        }
        .sidebar .nav-link.active {
            background-color: #0a58ca;
            color: white;
            font-weight: bold;
        }
        .sidebar .nav-link:hover {
            background-color: #0b60d9;
            color: white;
        }
        .sidebar-header {
            padding: 1rem 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .content {
            margin-left: 280px;
            padding: 2rem;
        }
        .navbar-top {
            margin-left: 280px;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 2rem;
        }
        .stat-card {
            border: none;
            border-left: 5px solid #0d6efd;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column p-3">
        <div class="sidebar-header">
            <i class="bi bi-airplane-engines-fill"></i> Admin Panel
        </div>

        <ul class="nav nav-pills flex-column mt-3 mb-auto">
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='dashboard') }}" class="nav-link {% if page == 'dashboard' %}active{% endif %}">
                    <i class="bi bi-grid-fill me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='flights') }}" class="nav-link {% if page == 'flights' %}active{% endif %}">
                    <i class="bi bi-airplane-fill me-2"></i> Manage Flights
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='bookings') }}" class="nav-link {% if page == 'bookings' %}active{% endif %}">
                    <i class="bi bi-journal-check me-2"></i> Manage Bookings
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='passengers') }}" class="nav-link {% if page == 'passengers' %}active{% endif %}">
                    <i class="bi bi-people-fill me-2"></i> Manage Passengers
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='employees') }}" class="nav-link {% if page == 'employees' %}active{% endif %}">
                    <i class="bi bi-briefcase-fill me-2"></i> Manage Employees
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='payroll') }}" class="nav-link {% if page == 'payroll' %}active{% endif %}">
                    <i class="bi bi-cash-coin me-2"></i> Manage Payroll
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='vendors') }}" class="nav-link {% if page == 'vendors' %}active{% endif %}">
                    <i class="bi bi-shop me-2"></i> Manage Vendors
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='reports') }}" class="nav-link {% if page == 'reports' %}active{% endif %}">
                    <i class="bi bi-bar-chart-line-fill me-2"></i> View Reports
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('dashboard_admin', page='audit') }}" class="nav-link {% if page == 'audit' %}active{% endif %}">
                    <i class="bi bi-clipboard2-data-fill me-2"></i> Audit Log
                </a>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('admin_roles') }}" class="nav-link">
                    <i class="bi bi-shield-lock-fill me-2"></i> Role & Permissions
                </a>
            </li>
        </ul>

        <div class="dropdown border-top pt-3 mt-3">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-3 me-2"></i>
                <span class="fw-bold">{{ session.name }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                <li><a class="dropdown-item" href="{{ url_for('logout') }}">Sign out</a></li>
            </ul>
        </div>
    </div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-top justify-content-end">
        <span class="navbar-text me-3">
            Logged in as: <strong>{{ session.name }} (Admin)</strong>
        </span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </nav>

    <!-- Main Content -->
    <main class="content">

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}


        <!-- ============================================= -->
        <!-- == 1. DASHBOARD HOME                         == -->
        <!-- ============================================= -->
        {% if page == 'dashboard' %}
        <h1 class="h2 mb-4">Dashboard Overview</h1>
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm stat-card h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-primary text-uppercase mb-1">Scheduled Flights</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ data.stats.flights }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-airplane-fill fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Other stat cards -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm stat-card border-left-success h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-success text-uppercase mb-1">Total Passengers</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ data.stats.passengers }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-people-fill fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm stat-card border-left-info h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-info text-uppercase mb-1">Confirmed Bookings</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ data.stats.bookings }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-journal-check fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card shadow-sm stat-card border-left-warning h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-warning text-uppercase mb-1">Total Employees</div>
                                <div class="h5 mb-0 fw-bold text-gray-800">{{ data.stats.employees }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-briefcase-fill fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 2. MANAGE FLIGHTS                         == -->
        <!-- ============================================= -->
        {% elif page == 'flights' %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Manage Flights</h1>
            <div>
                <form action="{{ url_for('run_status_update') }}" method="POST" class="d-inline-block me-2">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise"></i> Update Flight Statuses
                    </button>
                </form>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFlightModal">
                    <i class="bi bi-plus-circle-fill"></i> Add New Flight
                </button>
            </div>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Flight No.</th>
                                <th>Route</th>
                                <th>Aircraft</th>
                                <th>Departure</th>
                                <th>Arrival</th>
                                <th>Fare</th>
                                <th>Seats</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flight in data.flights %}
                            <tr>
                                <td class="fw-bold">{{ flight.flight_no }}<br><small class="text-muted">{{ flight.airline }}</small></td>
                                <td>{{ flight.source_code }} &rarr; {{ flight.dest_code }}</td>
                                <td>{{ flight.aircraft_model }}</td>
                                <td>{{ flight.departure_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ flight.arrival_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>${{ "%.2f"|format(flight.current_fare) }}</td>
                                <td>{{ flight.seats_booked }}/{{ flight.capacity }}</td>
                                <td><span class="badge bg-success">{{ flight.status }}</span></td>
                                <td>
                                    <form action="{{ url_for('admin_cancel_flight') }}" method="POST" class="d-inline">
                                        <input type="hidden" name="flight_id" value="{{ flight.flight_id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to cancel this flight?')">Cancel</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center">No upcoming flights found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Add Flight Modal -->
        <div class="modal fade" id="addFlightModal" tabindex="-1" aria-labelledby="addFlightModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form action="{{ url_for('add_flight') }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addFlightModalLabel">Add New Flight</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="flight_no" class="form-label">Flight Number</label>
                                    <input type="text" class="form-control" id="flight_no" name="flight_no" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="airline" class="form-label">Airline</label>
                                    <input type="text" class="form-control" id="airline" name="airline" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="route_id" class="form-label">Route</label>
                                    <select class="form-select" id="route_id" name="route_id" required>
                                        {% for route in data.routes %}
                                        <option value="{{ route.route_id }}">{{ route.source_name }} ({{ route.source_code }}) to {{ route.dest_name }} ({{ route.dest_code }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="aircraft_id" class="form-label">Aircraft</label>
                                    <select class="form-select" id="aircraft_id" name="aircraft_id" required>
                                        {% for ac in data.aircraft %}
                                        <option value="{{ ac.aircraft_id }}">{{ ac.model }} ({{ ac.registration_no }}) - Cap: {{ ac.capacity }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="departure_time" class="form-label">Departure Time</label>
                                    <input type="datetime-local" class="form-control" id="departure_time" name="departure_time" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="arrival_time" class="form-label">Arrival Time</label>
                                    <input type="datetime-local" class="form-control" id="arrival_time" name="arrival_time" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="base_fare" class="form-label">Base Fare</label>
                                <input type="number" step="0.01" class="form-control" id="base_fare" name="base_fare" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Flight</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 3. MANAGE BOOKINGS                        == -->
        <!-- ============================================= -->
        {% elif page == 'bookings' %}
        <h1 class="h2 mb-4">Manage Bookings</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Booking ID</th>
                                <th>Passenger</th>
                                <th>Flight No.</th>
                                <th>Booking Date</th>
                                <th>Seat</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in data.bookings %}
                            <tr>
                                <td class="fw-bold">{{ booking.booking_id }}</td>
                                <td>{{ booking.name }}</td>
                                <td>{{ booking.flight_no }}</td>
                                <td>{{ booking.booking_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ booking.seat_no }}</td>
                                <td>
                                    {% if booking.status == 'Confirmed' %}
                                    <span class="badge bg-success">Confirmed</span>
                                    {% elif booking.status == 'Cancelled' %}
                                    <span class="badge bg-danger">Cancelled</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ booking.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center">No bookings found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 4. MANAGE PASSENGERS                      == -->
        <!-- ============================================= -->
        {% elif page == 'passengers' %}
        <h1 class="h2 mb-4">Manage Passengers</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Passport No.</th>
                                <th>DOB</th>
                                <th>Loyalty Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in data.passengers %}
                            <tr>
                                <td>{{ p.passenger_id }}</td>
                                <td class="fw-bold">{{ p.name }}</td>
                                <td>{{ p.email }}</td>
                                <td>{{ p.passport_no }}</td>
                                <td>{{ p.dob.strftime('%Y-%m-%d') }}</td>
                                <td class="text-center">{{ p.total_points }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center">No passengers found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 5. MANAGE EMPLOYEES                       == -->
        <!-- ============================================= -->
        {% elif page == 'employees' %}
        <h1 class="h2 mb-4">Manage Employees</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="bi bi-plus-circle-fill"></i> Add New Employee
        </button>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Email</th>
                                <th>Joining Date</th>
                                <th>Salary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in data.employees %}
                            <tr>
                                <td>{{ e.emp_id }}</td>
                                <td class="fw-bold">{{ e.name }}</td>
                                <td>
                                    {% if e.role_name %}
                                    <span class="badge bg-primary">{{ e.role_name }}</span>
                                    <br><small class="text-muted">{{ e.role }}</small>
                                    {% else %}
                                    <span class="text-muted">{{ e.role or 'No role' }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ e.email }}</td>
                                <td>{{ e.date_of_joining.strftime('%Y-%m-%d') }}</td>
                                <td>${{ "%.2f"|format(e.salary) }}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editEmployeeModal-{{ e.emp_id }}">
                                        Edit
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- Edit Employee Modal -->
                            <div class="modal fade" id="editEmployeeModal-{{ e.emp_id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form action="{{ url_for('edit_employee') }}" method="POST">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Employee: {{ e.name }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" name="emp_id" value="{{ e.emp_id }}">
                                                <div class="mb-3">
                                                    <label class="form-label">Name</label>
                                                    <input type="text" class="form-control" name="name" value="{{ e.name }}" required>
                                                </div>
                                <div class="mb-3">
                                    <label class="form-label">System Role</label>
                                    <select class="form-select" name="role_id" required>
                                        <option value="">Select a role...</option>
                                        {% for role in data.roles %}
                                        <option value="{{ role.role_id }}" {% if e.role_id and role.role_id == e.role_id %}selected{% endif %}>
                                            {{ role.role_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Job Title</label>
                                    <input type="text" class="form-control" name="role_name" value="{{ e.role }}" required>
                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Email</label>
                                                    <input type="email" class="form-control" name="email" value="{{ e.email }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Joining Date</label>
                                                    <input type="date" class="form-control" name="date_of_joining" value="{{ e.date_of_joining.strftime('%Y-%m-%d') }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Salary</label>
                                                    <input type="number" step="0.01" class="form-control" name="salary" value="{{ e.salary }}" required>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <tr><td colspan="7" class="text-center">No employees found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for('add_employee') }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Employee</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Select Role (System Role)</label>
                                <select class="form-select" name="role_id" id="roleSelectAdd" required>
                                    <option value="">Select a role...</option>
                                    {% for role in data.roles %}
                                    <option value="{{ role.role_id }}">{{ role.role_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Job Title/Position</label>
                                <input type="text" class="form-control" name="role_name" placeholder="e.g., Senior Engineer" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Joining Date</label>
                                <input type="date" class="form-control" name="date_of_joining" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Salary</label>
                                <input type="number" step="0.01" class="form-control" name="salary" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Employee</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 6. MANAGE PAYROLL                         == -->
        <!-- ============================================= -->
        {% elif page == 'payroll' %}
        <h1 class="h2 mb-4">Manage Payroll</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPayrollModal">
            <i class="bi bi-plus-circle-fill"></i> Add Payroll Entry
        </button>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Pay Date</th>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Base Salary</th>
                                <th>Bonus</th>
                                <th>Deductions</th>
                                <th>Net Pay</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in data.payrolls %}
                            <tr>
                                <td>{{ p.pay_date.strftime('%Y-%m-%d') }}</td>
                                <td class="fw-bold">{{ p.name }}</td>
                                <td>{{ p.role }}</td>
                                <td>${{ "%.2f"|format(p.base_salary) }}</td>
                                <td class="text-success">+${{ "%.2f"|format(p.bonus) }}</td>
                                <td class="text-danger">-${{ "%.2f"|format(p.deductions) }}</td>
                                <td class="fw-bold">${{ "%.2f"|format(p.net_pay) }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="text-center">No payroll entries found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Payroll Modal -->
        <div class="modal fade" id="addPayrollModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for('add_payroll') }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Payroll Entry</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Employee</label>
                                <select class="form-select" name="emp_id" required>
                                    <option value="">Select Employee...</option>
                                    {% for e in data.employees %}
                                    <option value="{{ e.emp_id }}">{{ e.name }} (Base: ${{ "%.2f"|format(e.salary) }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Pay Date</label>
                                <input type="date" class="form-control" name="pay_date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bonus</label>
                                <input type="number" step="0.01" class="form-control" name="bonus" value="0.00" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Deductions</label>
                                <input type="number" step="0.01" class="form-control" name="deductions" value="0.00" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Entry</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- == 7. MANAGE VENDORS                         == -->
        <!-- ============================================= -->
        {% elif page == 'vendors' %}
        <h1 class="h2 mb-4">Manage Airport Vendors</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addVendorModal">
            <i class="bi bi-plus-circle-fill"></i> Add New Vendor
        </button>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Terminal</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in data.vendors %}
                            <tr>
                                <td>{{ v.vendor_id }}</td>
                                <td class="fw-bold">{{ v.name }}</td>
                                <td>{{ v.amenity_type }}</td>
                                <td>{{ v.terminal }}</td>
                                <td>{{ v.location_desc }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center">No vendors found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Vendor Modal -->
        <div class="modal fade" id="addVendorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="{{ url_for('add_vendor') }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Vendor</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Vendor Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amenity Type</label>
                                <input type="text" class="form-control" name="amenity_type" placeholder="e.g., Cafe, Lounge, Retail" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Terminal</label>
                                <input type="text" class="form-control" name="terminal" placeholder="e.g., T1, T2" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location Description</label>
                                <input type="text" class="form-control" name="location_desc" placeholder="e.g., Near Gate B5" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Vendor</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- == 8. VIEW REPORTS (PASSENGER SUMMARY)       == -->
        <!-- ============================================= -->
        {% elif page == 'reports' %}
        <h1 class="h2 mb-4">Reports - Passenger Summary</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <p>This view (<code>passenger_summary</code>) joins passengers, bookings, and payments to calculate total spending and bookings per passenger.</p>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Passenger</th>
                                <th>Passport No.</th>
                                <th>Total Bookings</th>
                                <th>Total Spent</th>
                                <th>Loyalty Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in data.passenger_summary %}
                            <tr>
                                <td class="fw-bold">{{ s.name }}<br><small class="text-muted">{{ s.email }}</small></td>
                                <td>{{ s.passport_no }}</td>
                                <td class="text-center">{{ s.total_bookings }}</td>
                                <td class="text-success fw-bold">${{ "%.2f"|format(s.total_spent) }}</td>
                                <td class="text-center">{{ s.total_points }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center">No summary data found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ============================================= -->
        <!-- == 9. AUDIT LOG                            == -->
        <!-- ============================================= -->
        {% elif page == 'audit' %}
        <h1 class="h2 mb-4">Audit Log</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <p>This log is populated by MySQL Triggers (e.g., <code>trg_audit_passenger_insert</code>, <code>trg_audit_booking_update</code>) on <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> actions.</p>
                <div class="table-responsive" style="max-height: 70vh;">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Timestamp</th>
                                <th>Table</th>
                                <th>Record ID</th>
                                <th>Action</th>
                                <th>Description</th>
                                <th>Changed By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in data.logs %}
                            <tr>
                                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td class="fw-bold">{{ log.table_name }}</td>
                                <td>{{ log.record_id }}</td>
                                <td>
                                    {% if log.action_type == 'CREATE' %}
                                    <span class="badge bg-success">CREATE</span>
                                    {% elif log.action_type == 'UPDATE' %}
                                    <span class="badge bg-warning text-dark">UPDATE</span>
                                    {% elif log.action_type == 'CANCEL' %}
                                    <span class="badge bg-danger">CANCEL</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ log.action_type }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.description }}</td>
                                <td>{{ log.changed_by }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center">No audit logs found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        {% endif %} <!-- End of page selection -->

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
